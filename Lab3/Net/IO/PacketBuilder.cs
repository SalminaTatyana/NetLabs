using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Lab3.Net.IO
{
    class PacketBuilder
    {
        MemoryStream _ms;
        Dictionary<char, int> ISO = new Dictionary<char, int>()
        {
            { '!', 33},
            { '"', 34},
            { '#', 35},
            {  '$',36},
            {  '%',37},
            {  '&',38},
            {'\'' ,39},
            {  '(',40},
            {  ')',41},
            {  '*',42},
            {  '+',43},
            { ',', 44},
            { '-', 45},
            { '.', 46},
            { '/', 47},
            { '0', 48},
            { '1', 49},
            { '2', 50},
            { '3', 51},
            { '4', 52},
            { '5', 53},
            { '6', 54},
            { '7', 55},
            { '8', 56},
            { '9', 57},
            { ':', 58},
            { ';', 59},
            { '<', 60},
            { '=', 61},
            { '>', 62},
            { '?', 63},
            { '@', 64},
            { 'A', 65},
            { 'B', 66},
            { 'C', 67},
            { 'D', 68},
            { 'E', 69},
            { 'F', 70},
            { 'G', 71},
            { 'H', 72},
            { 'I', 73},
            { 'J', 74},
            { 'K', 75},
            { 'L', 76},
            { 'M', 77},
            { 'N', 78},
            { 'O', 79},
            { 'P', 80},
            { 'Q', 81},
            { 'R', 82},
            { 'S', 83},
            { 'T', 84},
            { 'U', 85},
            { 'V', 86},
            { 'W', 87},
            { 'X', 88},
            { 'Y', 89},
            { 'Z', 90},
            { '[', 91},
            { '\\',92},
            { ']', 93},
            { '^', 94},
            { '_', 95},
            { '`', 96},
            { 'a', 97},
            { 'b', 98},
            { 'c', 99},
            {'d',100 },
            {'e',101 },
            {'f',102 },
            {'g',103 },
            {'h',104 },
            {'i',105 },
            {'j',106 },
            {'k',107 },
            {'l',108 },
            {'m',109 },
            {'n',110 },
            {'o',111 },
            {'p',112 },
            {'q',113 },
            {'r',114 },
            {'s',115 },
            {'t',116 },
            {'u',117 },
            {'v',118 },
            {'w',119 },
            {'x',120 },
            {'y',121 },
            {'z',122 },
            {'{',123 },
            {'|',124 },
            {'}',125 },
            {'~',126 },
            {' ',160 },
            {'Ё',161 },
            {'Ђ',162 },
            {'Ѓ',163 },
            {'Є',164 },
            {'Ѕ',165 },
            {'І',166 },
            {'Ї',167 },
            {'Ј',168 },
            {'Љ',169 },
            {'Њ',170 },
            {'Ћ',171 },
            {'¬',172 },
            {'Ў',174 },
            {'Џ',175 },
            {'А',176 },
            {'Б',177 },
            {'В',178 },
            {'Г',179 },
            {'Д',180 },
            {'Е',181 },
            {'Ж',182 },
            {'З',183 },
            {'И',184 },
            {'Й',185 },
            {'К',186 },
            {'Л',187 },
            {'М',188 },
            {'Н',189 },
            {'О',190 },
            {'П',191 },
            {'Р',192 },
            {'С',193 },
            {'Т',194 },
            {'У',195 },
            {'Ф',196 },
            {'Х',197 },
            {'Ц',198 },
            {'Ч',199 },
            {'Ш',200 },
            {'Щ',201 },
            {'Ъ',202 },
            {'Ы',203 },
            {'Ь',204 },
            {'Э',205 },
            {'Ю',206 },
            {'Я',207 },
            {'а',208 },
            {'б',209 },
            {'в',210 },
            {'г',211 },
            {'д',212 },
            {'е',213 },
            {'ж',214 },
            {'з',215 },
            {'и',216 },
            {'й',217 },
            {'к',218 },
            {'л',219 },
            {'м',220 },
            {'н',221 },
            {'о',222 },
            {'п',223 },
            {'р',224 },
            {'с',225 },
            {'т',226 },
            {'у',227 },
            {'ф',228 },
            {'х',229 },
            {'ц',230 },
            {'ч',231 },
            {'ш',232 },
            {'щ',233 },
            {'ъ',234 },
            {'ы',235 },
            {'ь',236 },
            {'э',237 },
            {'ю',238 },
            {'я',239 },
            {'№',240 },
            {'ё',241 },
            {'ђ',242 },
            {'ѓ',243 },
            {'є',244 },
            {'ї',247 },
            {'љ',249 },
            {'њ',250 },
            {'ћ',251 },
            {'ќ',252 },
            {'§',253 },
            {'ў',254 },
            {'џ',255 }
        };

        public PacketBuilder() {
            _ms = new MemoryStream();
        }
        public void WriteOpCode(byte opcode)
        {
            _ms.WriteByte(opcode);
        }

        
        public void WriteMessage(string msg)
        {
            var msgLength = msg.Length;
            _ms.Write(BitConverter.GetBytes(msgLength));
            _ms.Write(Code(msg));
        }
        public byte[] GetPacketBytes()
        {
            return _ms.ToArray();
        } 
        private byte[] Code(string str)
        {
            byte[] codeStrBin = new byte[str.Length];
            int j = 0;
            foreach (char item in str)
            {
                if (ISO.ContainsKey(item))
                {
                    codeStrBin[j] = (byte)ISO[item];
                    j = j + 1;

                }
            }
            
            return codeStrBin;
        }
            
    }
}
